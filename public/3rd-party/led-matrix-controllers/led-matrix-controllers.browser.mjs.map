{"version":3,"file":"led-matrix-controllers.browser.mjs","sources":["../src/hardware-constants.js","../src/web-serial/port.js","../src/web-serial/PortMutex.js","../src/web-serial/PortOperations.js","../src/supported-firmware/FrameworkComputer/inputmodule-rs/commands.js","../src/supported-firmware/FrameworkComputer/inputmodule-rs/CommandAbstractionLayer.js","../src/supported-firmware/FrameworkComputer/inputmodule-rs/DefaultController.js","../src/supported-firmware/sigroot/FW_LED_Matrix_Firmware/commands.js","../src/supported-firmware/sigroot/FW_LED_Matrix_Firmware/CommandAbstractionLayer.js","../src/supported-firmware/sigroot/FW_LED_Matrix_Firmware/SigrootController.js","../src/web-hid/device.js","../src/web-hid/HIDOperations.js","../src/web-hid/util.js","../src/supported-firmware/vddCore/sparkle-fw16/reports.js","../src/supported-firmware/vddCore/sparkle-fw16/ReportAbstractionLayer.js","../src/supported-firmware/vddCore/sparkle-fw16/SparkleController.js","../src/HardwareControllerFactory.js"],"sourcesContent":["export const WIDTH = 9;\r\nexport const HEIGHT = 34;\r\nexport const VID = 0x32AC;\r\nexport const VID_ARR = [0x32, 0xAC];\r\nexport const PID = 0x0020;\r\nexport const PID_ARR = [0x00, 0x20];\r\n\r\n// For PWM dimming (not for analog dimming/constant-current reduction!)\r\nexport const GAMMA = Object.freeze([\r\n  0, 0, 0, 0, 0, 0, 0, 1, \r\n  1, 1, 1, 1, 1, 1, 1, 1, \r\n  1, 1, 1, 1, 1, 1, 1, 1, \r\n  1, 1, 1, 1, 1, 1, 1, 1, \r\n  1, 1, 1, 2, 2, 2, 2, 2, \r\n  2, 2, 2, 2, 3, 3, 3, 3, \r\n  3, 3, 3, 4, 4, 4, 4, 4, \r\n  4, 5, 5, 5, 5, 6, 6, 6, \r\n  6, 6, 7, 7, 7, 7, 8, 8, \r\n  8, 9, 9, 9, 10, 10, 10, 11, \r\n  11, 11, 12, 12, 12, 13, 13, 14, \r\n  14, 14, 15, 15, 16, 16, 17, 17, \r\n  17, 18, 18, 19, 19, 20, 20, 21, \r\n  22, 22, 23, 23, 24, 24, 25, 26, \r\n  26, 27, 27, 28, 29, 29, 30, 31, \r\n  32, 32, 33, 34, 34, 35, 36, 37, \r\n  38, 38, 39, 40, 41, 42, 42, 43, \r\n  44, 45, 46, 47, 48, 49, 50, 51, \r\n  52, 53, 54, 55, 56, 57, 58, 59, \r\n  60, 61, 62, 63, 64, 66, 67, 68, \r\n  69, 70, 71, 73, 74, 75, 76, 78, \r\n  79, 80, 82, 83, 84, 86, 87, 88, \r\n  90, 91, 93, 94, 96, 97, 99, 100, \r\n  102, 103, 105, 106, 108, 110, 111, 113, \r\n  115, 116, 118, 120, 121, 123, 125, 127, \r\n  128, 130, 132, 134, 136, 138, 140, 141, \r\n  143, 145, 147, 149, 151, 153, 155, 157, \r\n  159, 161, 164, 166, 168, 170, 172, 174, \r\n  177, 179, 181, 183, 186, 188, 190, 193, \r\n  195, 197, 200, 202, 205, 207, 210, 212, \r\n  215, 217, 220, 222, 225, 228, 230, 233, \r\n  236, 238, 241, 244, 247, 249, 252, 255\r\n]);\r\n","import { PID, VID } from '../hardware-constants.js';\r\n\r\nconst filters = [{ usbVendorId: VID, usbProductId: PID }];\r\n\r\nexport class PortSelectionCancelled extends Error {\r\n  constructor() {\r\n    super('User cancelled port selection.');\r\n    this.name = this.constructor.name;\r\n    this.date = new Date();\r\n  }\r\n}\r\n\r\nexport class PortUnavailable extends Error {\r\n  constructor() {\r\n    super('Selected port already in use.');\r\n    this.name = this.constructor.name;\r\n    this.date = new Date();\r\n  }\r\n}\r\n\r\nasync function requestPort() {\r\n  try {\r\n    if (navigator.serial.requestPort) {\r\n      return await navigator.serial.requestPort({ filters });\r\n    } else {\r\n      return null; // Web Worker\r\n    }\r\n  } catch (e) {\r\n    switch (e.name) {\r\n      case ('NotFoundError'):\r\n        throw new PortSelectionCancelled();\r\n      case ('InvalidStateError'):\r\n        throw new PortUnavailable();\r\n      case ('SecurityError'): // No user gesture\r\n        return null;\r\n      default:\r\n        throw e;\r\n    }\r\n  }\r\n}\r\n\r\nclass KnownPorts {\r\n  used = new Set();\r\n  unused = [];\r\n\r\n  async getOrFetchUnused() {\r\n    let port = this.unused.pop();\r\n    \r\n    if (!port) {\r\n      const systemPorts = await navigator.serial.getPorts({ filters });\r\n      this.#enqueueUnique(systemPorts);\r\n      port = this.unused.pop();\r\n    }\r\n\r\n    if (!port) {\r\n      const manualPort = await requestPort();\r\n      this.#enqueueUnique([manualPort]);\r\n      port = this.unused.pop();\r\n    }\r\n\r\n    if (port) {\r\n      this.used.add(port);\r\n    }\r\n    \r\n    return port;\r\n  }\r\n\r\n  #enqueueUnique(ports) {\r\n    if (ports) {\r\n      for (const port of ports) {\r\n        if (port && !this.used.has(port) && !this.unused.includes(port)) {\r\n          this.unused.push(port);\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nconst knownPorts = new KnownPorts();\r\n\r\n/**\r\n * Adds user-selected port to permitted ports. Only for use outside of Web \r\n * Worker to establish permission for use within Web Worker.\r\n * @returns {null}\r\n */\r\nexport async function requestPortForWorker() {\r\n  const _ = await requestPort();\r\n}\r\n\r\n/**\r\n * Never returns the same port twice. \r\n * @returns {(SerialPort|null)}\r\n */\r\nexport async function getUnusedPort() {\r\n  return await knownPorts.getOrFetchUnused();\r\n}\r\n\r\n/**\r\n * Close port without throwing if already closed.\r\n * @param {SerialPort} port \r\n */\r\nexport async function close(port) {\r\n  try {\r\n    await port.close();\r\n  } catch(e) {\r\n    if (e.name != 'InvalidStateError') {\r\n      if (e.message.includes('The port is already closed')) {\r\n        throw e;\r\n      }\r\n    }\r\n  }\r\n}\r\n","export class PortMutex {\r\n  constructor(portOperations) {\r\n    this.#lockName = `port-mutex-${Math.random().toString()}`;\r\n    this.#deduper = new Map();\r\n    this.#portOps = portOperations;\r\n  }\r\n\r\n  async acquire(fn) {\r\n    const trace = new Error('created bad cb').stack;\r\n\r\n    await this.#enqueue(async () => {\r\n      try {\r\n        await fn(this.#portOps);\r\n      } catch (e) {\r\n        console.error('Error occured in anonymous callback.');\r\n        console.error('Original error:', e);\r\n        console.error('--- This callback was created at ---\\n', trace);\r\n      }\r\n    });\r\n  }\r\n\r\n  async acquireIdempotent(key, fn) {\r\n    const trace = new Error('created bad cb').stack;\r\n\r\n    if (this.#deduper.has(key)) {\r\n      console.info(`\"${key}\" request coalesced.`);\r\n    }\r\n\r\n    this.#deduper.set(key, async () => {\r\n      try {\r\n        await fn(this.#portOps);\r\n      } catch (e) {\r\n        console.error('Error occured in anonymous callback.');\r\n        console.error('Original error:', e);\r\n        console.error('--- This callback was created at ---\\n', trace);\r\n      }\r\n    });\r\n\r\n    await this.#enqueue(() => this.#execDedupedOp(key));\r\n  }\r\n\r\n  async #enqueue(fn) {\r\n    // `navigator.locks` maintains queue and provides mutual exclusion.\r\n    return navigator.locks.request(this.#lockName, fn);\r\n  }\r\n\r\n  async #execDedupedOp(key) {\r\n    if (this.#deduper.has(key)) {\r\n      const fn = this.#deduper.get(key);\r\n      this.#deduper.delete(key);\r\n      await fn();\r\n    }\r\n  }\r\n\r\n  #lockName;\r\n  #deduper;\r\n  #portOps;\r\n}\r\n","export class PortOperations {\r\n  constructor(port) {\r\n    this.#port = port;\r\n  }\r\n\r\n  async rx(length, timeout=3000) {\r\n    if (this.#port === null) {\r\n      throw new Error('attempted RX before port initialization.');\r\n    }\r\n\r\n    /*\r\n     * ReadableStream's built-in locking mechanism cannot be awaited or otherwise\r\n     * asynchronously acquired. A PortMutex must be used.\r\n     */\r\n    if (this.#port.readable.locked) {\r\n      throw new Error('attempted RX while port locked.');\r\n    }\r\n\r\n    const response = [];\r\n    const reader = this.#port.readable.getReader();\r\n    const timeoutHandle = setTimeout(() => reader.cancel(), timeout);\r\n\r\n    try {\r\n      // Response may be divided across multiple reads\r\n      while (response.length < length) {\r\n        const { value, done } = await reader.read();\r\n        response.push(...(value ?? []));\r\n        if (done || !value) break;\r\n      }\r\n    } finally {\r\n      clearTimeout(timeoutHandle);\r\n      reader.releaseLock();\r\n    }\r\n\r\n    return response;\r\n  }\r\n\r\n  async tx(buffer) {\r\n    if (this.#port === null) {\r\n      throw new Error('attempted TX before port initialization.');\r\n    }\r\n    \r\n    /*\r\n     * WritableStream's built-in locking mechanism cannot be awaited or otherwise\r\n     * asynchronously acquired. A PortMutex must be used.\r\n     */\r\n    if (this.#port.writable.locked) {\r\n      throw new Error('attempted TX while port locked.');\r\n    }\r\n\r\n    const writer = this.#port.writable.getWriter();\r\n\r\n    try {\r\n      await writer.write(new Uint8Array(buffer));\r\n    } finally {\r\n      /* \r\n       * The writer must be completely torn down between every single write.\r\n       * Many parsers can't handle delayed flushing and write coalescing.\r\n       * Command sequences will fail if `releaseLock()` is used here.\r\n       */\r\n      await writer.close();\r\n    }\r\n  }\r\n\r\n  #port;\r\n}\r\n","// All replies to all commands are 32 bytes\r\nexport const RX_PACKET_SZ = 32;\r\n\r\nexport const Command = Object.freeze({\r\n  ANIMATE: 0x04,\r\n  BRIGHTNESS: 0x00,\r\n  BOOTLOADER: 0x02,\r\n  DRAW: 0x06,\r\n  DRAW_GREY_COL_BUFFER: 0x08,\r\n  GAME_CTRL: 0x11,\r\n  GAME_STATUS: 0x12,\r\n  PANIC: 0x05,\r\n  PATTERN: 0x01,\r\n  SLEEP: 0x03,\r\n  STAGE_GREY_COL: 0x07,\r\n  START_GAME: 0x10,\r\n  VERSION: 0x20,\r\n});\r\n\r\n// Used with Command.PATTERN\r\nexport const Pattern = Object.freeze({\r\n  DISPLAY_LOTUS_HORIZONTAL: 0x03,\r\n  DISPLAY_LOTUS_VERTICAL: 0x07,\r\n  DISPLAY_PANIC: 0x06,\r\n  DOUBLE_GRADIENT: 0x02,\r\n  FULL_BRIGHTNESS: 0x05,\r\n  GRADIENT: 0x01,\r\n  PERCENTAGE: 0x00,\r\n  ZIG_ZAG: 0x04,\r\n});\r\n\r\n// DRAW or DRAW_GREY_COL_BUFFER\r\nexport const BitDepth = Object.freeze({\r\n  GRAY_8BIT: '8-bit',\r\n  MONO_1BIT: '1-bit',\r\n})\r\n","import { GAMMA, HEIGHT, VID_ARR, WIDTH } from '../../../hardware-constants.js';\r\nimport { Command, RX_PACKET_SZ } from './commands.js';\r\n\r\nexport class CommandAbstractionLayer {\r\n  constructor(portMutex = null) {\r\n    this.portMutex = portMutex;\r\n  }\r\n\r\n  async bootloader() {\r\n    await this.portMutex.acquire(async p => {\r\n      await p.tx([...VID_ARR, Command.BOOTLOADER]);\r\n    });\r\n  }\r\n\r\n  async brightness(brightness) {\r\n    await this.portMutex.acquire(async p => {\r\n      await p.tx([...VID_ARR, Command.BRIGHTNESS, brightness]);\r\n    });\r\n  }\r\n\r\n  async draw(matrix) {\r\n    let index = 0;\r\n    let output = new Uint8Array(39).fill(0);\r\n\r\n    // Pack cells into bits\r\n    for (let r = 0; r < HEIGHT; r++) {\r\n      for (let c = 0; c < WIDTH; c++) {\r\n        if (matrix[r][c]) {\r\n          output[index >> 3] |= 1 << index % 8;\r\n        }\r\n        index++;\r\n      }\r\n    }\r\n\r\n    await this.portMutex.acquireIdempotent(\r\n      'drawMatrix', \r\n      async p => {\r\n        await p.tx([...VID_ARR, Command.DRAW, ...output]);\r\n      }\r\n    );\r\n  }\r\n\r\n  async drawGrayscale(matrix) {\r\n    // Transpose & Gamma Correction\r\n    const buffers = Array.from(\r\n      { length: WIDTH }, \r\n      (_, c) => Array.from(\r\n        { length: HEIGHT }, \r\n        (_, r) => GAMMA[Math.floor((matrix[r][c] ?? 0) * 255)]\r\n      )\r\n    );\r\n\r\n    // Only execute the most recent call \r\n    await this.portMutex.acquireIdempotent(\r\n      'drawMatrix', \r\n      async p => {\r\n        for (let i = 0; i < WIDTH; i++) {\r\n          await p.tx([...VID_ARR, Command.STAGE_GREY_COL, i, ...buffers[i]]);\r\n        }\r\n        await p.tx([...VID_ARR, Command.DRAW_GREY_COL_BUFFER]);\r\n      }\r\n    );\r\n  }\r\n\r\n  async asleep() {\r\n    let asleep = false;\r\n\r\n    await this.portMutex.acquire(async p => {\r\n      await p.tx([...VID_ARR, Command.SLEEP]);\r\n      asleep = await p.rx(RX_PACKET_SZ);\r\n      asleep = asleep[0] != 0x00;\r\n    });\r\n\r\n    return asleep;\r\n  }\r\n\r\n  async sleep() {\r\n    await this.portMutex.acquire(async p => {\r\n      await p.tx([...VID_ARR, Command.SLEEP, 0x01]);\r\n    });\r\n  }\r\n\r\n  async wake() {\r\n    await this.portMutex.acquire(async p => {\r\n      await p.tx([...VID_ARR, Command.SLEEP]);\r\n    });\r\n  }\r\n\r\n  async pattern(pattern) {\r\n    await this.portMutex.acquireIdempotent(\r\n      'drawMatrix',\r\n      async p => {\r\n        await p.tx([...VID_ARR, Command.PATTERN, pattern]);\r\n      }\r\n    );\r\n  }\r\n\r\n  async percent(percent) {\r\n    await this.portMutex.acquireIdempotent(\r\n      'drawMatrix',\r\n      async p => {\r\n        await p.tx([...VID_ARR, Command.PATTERN, Pattern.PERCENTAGE, percent]);\r\n      }\r\n    );\r\n  }\r\n\r\n  async version() {\r\n    let ver = {};\r\n\r\n    await this.portMutex.acquire(async p => {\r\n      await p.tx([...VID_ARR, Command.VERSION]);\r\n      const response = await p.rx(RX_PACKET_SZ);\r\n\r\n      // MMMMMMMM mmmmPPPP 0000000p\r\n      ver.major = response[0];\r\n      ver.minor = response[1] >> 4;\r\n      ver.patch = response[1] & 0x0F;\r\n      ver.preRelease = response[2] == 1;\r\n    });\r\n\r\n    return ver;\r\n  }\r\n}\r\n","import { close, getUnusedPort } from '../../../web-serial/port.js';\r\nimport { PortMutex } from '../../../web-serial/PortMutex.js';\r\nimport { PortOperations } from '../../../web-serial/PortOperations.js';\r\nimport { CommandAbstractionLayer } from './CommandAbstractionLayer.js';\r\nimport { BitDepth } from './commands.js';\r\n\r\nexport class DefaultController extends CommandAbstractionLayer {\r\n  async bootloader() {\r\n    await super.bootloader();\r\n  }\r\n\r\n  async connect() {\r\n    const port = await getUnusedPort();\r\n\r\n    if (port?.connected) {\r\n      await close(port);\r\n      await port.open({ baudRate: 115200 });\r\n      this.portMutex = new PortMutex(new PortOperations(port));\r\n    } else {\r\n      throw new Error('No Port Found');\r\n    }\r\n  }\r\n\r\n  async draw(matrix) {\r\n    switch (this.bitDepth ?? BitDepth.MONO_1BIT) {\r\n\r\n      case (BitDepth.GRAY_8BIT):\r\n        await super.drawGrayscale(matrix);\r\n        break;\r\n\r\n      case (BitDepth.MONO_1BIT):\r\n        await super.draw(matrix);\r\n        break;\r\n\r\n      default:\r\n        console.error(`Unsupported bitdepth: ${this.bitDepth}`);\r\n    }\r\n  }\r\n\r\n  async verifyFirmware() {\r\n    try {\r\n      const version = await super.version();\r\n\r\n      return version\r\n        && version.major != undefined\r\n        && version.minor != undefined\r\n        && version.patch != undefined\r\n        && version.preRelease != undefined;\r\n        \r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async version() {\r\n    return super.version();\r\n  }\r\n}\r\n","export const Command = Object.freeze({\r\n  /* 000 */ NOOP: 0x00,\r\n  /* 'd' */ ANIMATION_DIAMOND: 0x64,\r\n  /* 'b' */ ANIMATION_FIRE: 0x62,\r\n  /* 'f' */ ANIMATION_FIREPLACE: 0x66,\r\n  /* 'g' */ ANIMATION_GEAR: 0x67,\r\n  /* 'r' */ ANIMATION_RING: 0x72,\r\n  /* 'a' */ ANIMATION_STARTUP: 0x61,\r\n  /* 'A' */ ANIMATION_STARTUP_ONCE: 0x41,\r\n  /* 'e' */ BOOTLOADER: 0x65,\r\n  /* 'm' */ DRAW_PWM: 0x6D,\r\n  /* 'M' */ DRAW_PWM_BLOCKING: 0x4D,\r\n  /* 'n' */ DRAW_SCALE: 0x6E,\r\n  /* 'N' */ DRAW_SCALE_BLOCKING: 0x4E,\r\n  /* 'c' */ FLUSH_CMD_QUEUE: 0x63,\r\n  /* 't' */ TEST_PATTERN: 0x74,\r\n  /* 'w' */ SET_CONST_PWM: 0x77,\r\n  /* 's' */ SET_CONST_SCALE: 0x73,\r\n  /* 'p' */ SET_PX_PWM: 0x70,\r\n  /* 'q' */ SET_PX_SCALE: 0x71,\r\n  /* 127 */ IDENTITY_STRING: 0x7F,\r\n});\r\n\r\nexport const IDENTITY_STR_LEN = 25;\r\n\r\nexport const IDENTITY_STR_REGEX = /^Sig\\sFW\\sLED\\sMatrix\\sFW\\sV(\\d+)\\.(\\d+)$/;\r\n","import { GAMMA } from '../../../hardware-constants.js';\r\nimport { Command, IDENTITY_STR_LEN } from './commands.js';\r\n\r\nexport class CommandAbstractionLayer {\r\n  constructor(portMutex = null) {\r\n    this.portMutex = portMutex;\r\n  }\r\n\r\n  async bootloader() {\r\n    await this.portMutex.acquire(async p => {\r\n      await p.tx([Command.BOOTLOADER]);\r\n    });\r\n  }\r\n\r\n  async identityString() {\r\n    let ident = null;\r\n\r\n    await this.portMutex.acquire(async p => {\r\n      await p.tx([Command.IDENTITY_STRING]);\r\n      ident = await p.rx(IDENTITY_STR_LEN);\r\n    });\r\n\r\n    return String.fromCharCode(...ident);\r\n  }\r\n\r\n  async setPixelPwm(r, c, brightness) {\r\n    await this.portMutex.acquire(\r\n      async p => {\r\n        await p.tx([Command.SET_PX_PWM, c, r, brightness]);\r\n      }\r\n    );\r\n  }\r\n\r\n  async setGlobalPwm(brightness) {\r\n    await this.portMutex.acquire(\r\n      async p => {\r\n        await p.tx([Command.SET_CONST_PWM, brightness]);\r\n      }\r\n    );\r\n  }\r\n\r\n  async setMatrixPwm(matrix) {\r\n    // Only execute the most recent call \r\n    await this.portMutex.acquireIdempotent(\r\n      'drawMatrix', \r\n      async p => {\r\n        await p.tx(\r\n          [Command.DRAW_PWM].concat(\r\n            matrix.flat().map(v => \r\n              GAMMA[Math.floor((v ?? 0) * 255)]\r\n            )\r\n          )\r\n        );\r\n      }\r\n    );\r\n  }\r\n\r\n  async setPixelAnalog(r, c, brightness) {\r\n    await this.portMutex.acquire(\r\n      async p => {\r\n        await p.tx([Command.SET_PX_SCALE, c, r, brightness]);\r\n      }\r\n    );\r\n  }\r\n\r\n  async setGlobalAnalog(brightness) {\r\n    await this.portMutex.acquire(\r\n      async p => {\r\n        await p.tx([Command.SET_CONST_SCALE, brightness]);\r\n      }\r\n    );\r\n  }\r\n\r\n  async setMatrixAnalog(matrix) {\r\n    // Only execute the most recent call \r\n    await this.portMutex.acquireIdempotent(\r\n      'drawMatrix', \r\n      async p => {\r\n        await p.tx(\r\n          [Command.DRAW_SCALE].concat(\r\n            matrix.flat().map(v => \r\n              GAMMA[Math.floor((v ?? 0) * 255)]\r\n            )\r\n          )\r\n        );\r\n      }\r\n    );\r\n  }\r\n}\r\n","import { close, getUnusedPort } from '../../../web-serial/port.js';\r\nimport { PortMutex } from '../../../web-serial/PortMutex.js';\r\nimport { PortOperations } from '../../../web-serial/PortOperations.js';\r\nimport { CommandAbstractionLayer } from './CommandAbstractionLayer.js';\r\nimport { IDENTITY_STR_REGEX } from './commands.js';\r\n\r\nexport class SigrootController extends CommandAbstractionLayer {\r\n  async bootloader() {\r\n    await super.bootloader();\r\n  }\r\n\r\n  async connect() {\r\n    const port = await getUnusedPort();\r\n\r\n    if (port?.connected) {\r\n      await close(port);\r\n      await port.open({ baudRate: 115200 });\r\n      this.portMutex = new PortMutex(new PortOperations(port));\r\n    }\r\n  }\r\n\r\n  async draw(matrix) {\r\n    if (!this.#scaleInitialized) {\r\n      await super.setGlobalAnalog(0x20);\r\n      this.#scaleInitialized = true;\r\n    } else {\r\n      throw new Error('No Port Found');\r\n    }\r\n\r\n    await super.setMatrixPwm(matrix);\r\n  }\r\n\r\n  async verifyFirmware() { \r\n    return await this.version() != null;\r\n  }\r\n\r\n  async version() {\r\n    const ident = await super.identityString();\r\n    const match = ident.match(IDENTITY_STR_REGEX);\r\n\r\n    if (match && match.length == 3) {\r\n      return {\r\n        major: match[1],\r\n        minor: match[2]\r\n      }\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  #scaleInitialized;\r\n}\r\n","import { PID, VID } from '../hardware-constants.js';\r\n\r\nconst filters = [{ vendorId: VID, productId: PID }];\r\n\r\nexport class DeviceSelectionCancelled extends Error {\r\n  constructor() {\r\n    super('User cancelled device selection.');\r\n    this.name = this.constructor.name;\r\n    this.date = new Date();\r\n  }\r\n}\r\n\r\nasync function requestDevice() {\r\n  try {\r\n    if (navigator.serial.requestPort) {\r\n      return await navigator.serial.requestDevice({ filters });\r\n    } else {\r\n      return null; // Web Worker\r\n    }\r\n  } catch (e) {\r\n    switch (e.name) {\r\n      case ('NotFoundError'):\r\n        throw new DeviceSelectionCancelled();\r\n      case ('SecurityError'): // No user gesture\r\n        return null;\r\n      default:\r\n        throw e;\r\n    }\r\n  }\r\n}\r\n\r\nclass KnownDevices {\r\n  used = new Set();\r\n  unused = [];\r\n\r\n  async getOrFetchUnused() {\r\n    let device = this.unused.pop();\r\n\r\n    if (!device) {\r\n      const systemDevices = await navigator.hid.getDevices({ filters });\r\n      this.#enqueueUnique(systemDevices);\r\n      device = this.unused.pop();\r\n    }\r\n\r\n    if (!device) {\r\n      const manualDevices = await requestDevice();\r\n      this.#enqueueUnique([manualDevices]);\r\n      device = this.unused.pop();\r\n    }\r\n\r\n    if (device) {\r\n      this.used.add(device);\r\n    }\r\n\r\n    return device;\r\n  }\r\n\r\n  #enqueueUnique(devices) {\r\n    if (devices) {\r\n      for (const dev of devices) {\r\n        if (dev && !this.used.has(dev) && !this.unused.includes(dev)) {\r\n          this.unused.push(dev);\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nconst knownDevices = new KnownDevices();\r\n\r\n/**\r\n * Adds user-selected device to permitted device. Only for use outside of Web \r\n * Worker to establish permission for use within Web Worker.\r\n * @returns {null}\r\n */\r\nexport async function reqestDeviceForWorker() {\r\n  const _ = await requestDevice();\r\n}\r\n\r\n/**\r\n * Never returns the same device twice. \r\n * @returns {(HIDDevice|null)}\r\n */\r\nexport async function getUnusedDevice() {\r\n  return await knownDevices.getOrFetchUnused();\r\n}\r\n","import { pad } from './util.js';\r\n\r\nexport class HIDOperations {\r\n  constructor(device) {\r\n    this.#device = device;\r\n  }\r\n\r\n  async send(report, data) {\r\n    if (data.length < report.bytes) {\r\n      data = pad(data, report.bytes);\r\n    } else if (data.length > report.bytes) {\r\n      throw new Error('Unable to send report: too many bytes');\r\n    }\r\n\r\n    const buffer = new Uint8Array(data).buffer;\r\n\r\n    if (report.feature)  {\r\n      await this.#device.sendFeatureReport(report.id, buffer);\r\n    } else {\r\n      await this.#device.sendReport(report.id, buffer);\r\n    }\r\n  }\r\n\r\n  async request(report) {\r\n    let reply = [];\r\n\r\n    if (report.feature) {\r\n      reply = await this.#device.receiveFeatureReport(report.id);\r\n    } else {\r\n      /* \r\n       * HID input reports are used for unprompted data.\r\n       * See WebHID `HIDInputReportEvent`\r\n       */\r\n      throw new Error('Invalid operation');\r\n    }\r\n\r\n    if (reply.byteLength != report.bytes) {\r\n      const exp = report.bytes;\r\n      const act = reply.byteLength;\r\n      console.error(`reply length=${act} (expected ${exp})`);\r\n    }\r\n\r\n    return reply;\r\n  }\r\n\r\n  #device;\r\n}\r\n","export function pad(arr, len, val=0x00) {\r\n  return arr.concat(new Array(len - arr.length).fill(val));\r\n}\r\n","export const Reports = {\r\n  GLITTER_DEVICE_INFO: {\r\n    id: 0x01,\r\n    bytes: 307,\r\n    feature: true,\r\n  },\r\n  GLITTER_BASIC_CMD: {\r\n    id: 0x02,\r\n    bytes: 16,\r\n    feature: true,\r\n  },\r\n  GLITTER_GRID_PWM_CNTL: {\r\n    id: 0x03,\r\n    bytes: 306,\r\n    feature: true,\r\n  },\r\n  GLITTER_GRID_PWM_CNTL: {\r\n    id: 0x04,\r\n    bytes: 306,\r\n    feature: true,\r\n  }\r\n}\r\n\r\nexport const Commands = {\r\n  GLITTER_CMD_REBOOT: 0x00,\r\n  GLITTER_CMD_SLEEP: 0x01,\r\n  GLITTER_CMD_WAKE_ON_COMMAND: 0x02,\r\n  GLITTER_CMD_SET_SLEEP_TIMEOUT: 0x03,\r\n  GLITTER_CMD_SET_GLOBAL_BRIGHTNESS: 0x04,\r\n  GLITTER_CMD_DRAW_PIXEL: 0x05,\r\n  GLITTER_CMD_DRAW_LINE: 0x06\r\n}\r\n\r\nexport const BootMode = {\r\n  BOOTSEL: 0x00,\r\n  NORMAL: 0x01,\r\n}\r\n","import { GAMMA } from '../../../hardware-constants.js';\r\nimport { Commands, Reports } from './reports.js';\r\n\r\nexport class ReportAbstractionLayer {\r\n  constructor(device = null) {\r\n    this.device = device;\r\n  }\r\n\r\n  async info() {\r\n    const infoRaw = await this.device.request(Reports.GLITTER_DEVICE_INFO);\r\n\r\n    return {\r\n      sleep_pin: infoRaw.getUint8(1),\r\n      dip1_pin: infoRaw.getUint8(2),\r\n      intb_pin: infoRaw.getUint8(3),\r\n      state_flags: infoRaw.getUint8(4),\r\n      id_reg: infoRaw.getUint8(5),\r\n      config_reg: infoRaw.getUint8(6),\r\n      global_brightness: infoRaw.getUint8(7),\r\n      display_width: infoRaw.getUint8(8),\r\n      display_height: infoRaw.getUint8(9),\r\n      timeout_ms: infoRaw.getUint32(10),\r\n      version_major: infoRaw.getUint8(14),\r\n      version_minor: infoRaw.getUint8(15),\r\n    };\r\n  }\r\n\r\n  async wake() {\r\n    await this.device.send(\r\n      Reports.GLITTER_BASIC_CMD,\r\n      [Commands.GLITTER_CMD_SLEEP, false]\r\n    );\r\n  }\r\n\r\n  async sleep() {\r\n    await this.device.send(\r\n      Reports.GLITTER_BASIC_CMD,\r\n      [Commands.GLITTER_CMD_SLEEP, true]\r\n    );\r\n  }\r\n\r\n  async disableSleep() {\r\n    await this.device.send(\r\n      Reports.GLITTER_BASIC_CMD, \r\n      [Commands.GLITTER_CMD_SET_SLEEP_TIMEOUT, 0xff, 0xff, 0xff, 0xff]\r\n    );\r\n  }\r\n\r\n  async disableDeepSleep() {\r\n    await this.device.send(\r\n      Reports.GLITTER_BASIC_CMD, \r\n      [Commands.GLITTER_CMD_WAKE_ON_COMMAND, 0x01]\r\n    );\r\n  }\r\n\r\n  async disableSleepTimer() {\r\n    await this.device.send(\r\n      Reports.GLITTER_BASIC_CMD, \r\n      [Commands.GLITTER_CMD_SET_SLEEP_TIMEOUT, 0x00, 0x00, 0x00, 0x00]\r\n    );\r\n  }\r\n  \r\n  async enableDeepSleep() {\r\n    await this.device.send(\r\n      Reports.GLITTER_BASIC_CMD, \r\n      [Commands.GLITTER_CMD_WAKE_ON_COMMAND, 0x00]\r\n    );\r\n  }\r\n\r\n  async enableSleepTimer(milliseconds) {\r\n    const view = new DataView(new ArrayBuffer(4));\r\n    const littleEndian = false;\r\n    view.setInt32(0, milliseconds, littleEndian);\r\n    await this.device.send(\r\n      Reports.GLITTER_BASIC_CMD, \r\n      [\r\n        Commands.GLITTER_CMD_SET_SLEEP_TIMEOUT, \r\n        view.getUint8(0), \r\n        view.getUint8(1), \r\n        view.getUint8(2), \r\n        view.getUint8(3),\r\n      ]\r\n    );\r\n  }\r\n\r\n  async reboot(mode) {\r\n    await this.device.send(\r\n      Reports.GLITTER_BASIC_CMD, \r\n      [Commands.GLITTER_CMD_REBOOT, mode]\r\n    );\r\n  }\r\n\r\n  async drawMatrix(matrix) {\r\n    await this.device.send(\r\n      Reports.GLITTER_GRID_PWM_CNTL,\r\n      matrix.flat().map(v => GAMMA[Math.floor((v ?? 0) * 255)])\r\n    );\r\n  }\r\n\r\n  async drawPixel(r, c, brightness) {\r\n    await this.device.send(\r\n      Reports.GLITTER_BASIC_CMD,\r\n      [Commands.GLITTER_CMD_DRAW_PIXEL, c, r, brightness]\r\n    );\r\n  }\r\n\r\n  async drawLine({r1, c1}, {r2, c2}, brightness) {\r\n    await this.device.send(\r\n      Reports.GLITTER_BASIC_CMD,\r\n      [Commands.GLITTER_CMD_DRAW_PIXEL, r1, c1, r2, c2, brightness]\r\n    );\r\n  }\r\n\r\n  device;\r\n}\r\n","import { HEIGHT, WIDTH } from '../../../hardware-constants.js';\r\nimport { getUnusedDevice } from '../../../web-hid/device.js';\r\nimport { HIDOperations } from '../../../web-hid/HIDOperations.js';\r\nimport { ReportAbstractionLayer } from './ReportAbstractionLayer.js';\r\nimport { BootMode } from './reports.js';\r\n\r\nexport class SparkleController extends ReportAbstractionLayer {\r\n  async bootloader() {\r\n    await super.reboot(BootMode.BOOTSEL);\r\n  }\r\n\r\n  async connect() {\r\n    const device = await getUnusedDevice();\r\n\r\n    if (device) {\r\n      await device.open();\r\n      this.device = new HIDOperations(device);\r\n    } else {\r\n      throw new Error('No Device Found');\r\n    }\r\n  }\r\n  \r\n  async draw(matrix) {\r\n    await super.drawMatrix(matrix);\r\n  }\r\n\r\n  async verifyFirmware() {\r\n    try {\r\n      const info = await super.info();\r\n      return (\r\n        info.display_height == HEIGHT &&\r\n        info.display_width == WIDTH\r\n      );\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async version() {\r\n    const info = await super.info();\r\n\r\n    if (info.version_major != undefined \r\n      && info.version_minor != undefined\r\n      && (info.version_major > 0 || info.version_minor > 0)) {\r\n      return {\r\n        major: info.version_major,\r\n        minor: info.version_minor\r\n      }\r\n    } else {\r\n      // Sparkle <=1.1.1: Glitter version unavailable \r\n      return { major: 1, minor: 0 };\r\n    }\r\n  }\r\n}\r\n","import { DefaultController } from './supported-firmware/FrameworkComputer/inputmodule-rs/DefaultController.js';\r\nimport { SigrootController } from './supported-firmware/sigroot/FW_LED_Matrix_Firmware/SigrootController.js';\r\nimport { SparkleController } from './supported-firmware/vddCore/sparkle-fw16/SparkleController.js';\r\n\r\nexport class HardwareControllerFactory {\r\n  static async detectSerial() {\r\n    const c1 = new DefaultController();\r\n    const c2 = new SigrootController();\r\n\r\n    await c1.connect();\r\n    if (await c1.verifyFirmware()) {\r\n      return c1;\r\n    }\r\n    \r\n    await c2.connect()\r\n    if (await c2.verifyFirmware()) {\r\n      return c2;\r\n    } \r\n    \r\n    return null;\r\n  }\r\n\r\n  static async detectHID() {\r\n    const c1 = new SparkleController();\r\n\r\n    await c1.connect();\r\n    if (await c1.verifyFirmware()) {\r\n      return c1;\r\n    } \r\n    \r\n    return null;\r\n  }\r\n}\r\n"],"names":["WIDTH","HEIGHT","VID","VID_ARR","PID","PID_ARR","GAMMA","Object","freeze","filters","usbVendorId","usbProductId","PortSelectionCancelled","Error","constructor","super","this","name","date","Date","PortUnavailable","async","requestPort","navigator","serial","e","knownPorts","used","Set","unused","getOrFetchUnused","port","pop","systemPorts","getPorts","enqueueUnique","manualPort","add","ports","has","includes","push","requestPortForWorker","getUnusedPort","close","message","PortMutex","portOperations","lockName","Math","random","toString","deduper","Map","portOps","acquire","fn","trace","stack","enqueue","console","error","acquireIdempotent","key","info","set","execDedupedOp","locks","request","get","delete","PortOperations","rx","length","timeout","readable","locked","response","reader","getReader","timeoutHandle","setTimeout","cancel","value","done","read","clearTimeout","releaseLock","tx","buffer","writable","writer","getWriter","write","Uint8Array","Command","ANIMATE","BRIGHTNESS","BOOTLOADER","DRAW","DRAW_GREY_COL_BUFFER","GAME_CTRL","GAME_STATUS","PANIC","PATTERN","SLEEP","STAGE_GREY_COL","START_GAME","VERSION","BitDepth","GRAY_8BIT","MONO_1BIT","CommandAbstractionLayer$1","portMutex","bootloader","p","brightness","draw","matrix","index","output","fill","r","c","drawGrayscale","buffers","Array","from","_","floor","i","asleep","sleep","wake","pattern","percent","Pattern","PERCENTAGE","version","ver","major","minor","patch","preRelease","DefaultController","CommandAbstractionLayer","connect","connected","open","baudRate","bitDepth","verifyFirmware","undefined","NOOP","ANIMATION_DIAMOND","ANIMATION_FIRE","ANIMATION_FIREPLACE","ANIMATION_GEAR","ANIMATION_RING","ANIMATION_STARTUP","ANIMATION_STARTUP_ONCE","DRAW_PWM","DRAW_PWM_BLOCKING","DRAW_SCALE","DRAW_SCALE_BLOCKING","FLUSH_CMD_QUEUE","TEST_PATTERN","SET_CONST_PWM","SET_CONST_SCALE","SET_PX_PWM","SET_PX_SCALE","IDENTITY_STRING","IDENTITY_STR_REGEX","identityString","ident","String","fromCharCode","setPixelPwm","setGlobalPwm","setMatrixPwm","concat","flat","map","v","setPixelAnalog","setGlobalAnalog","setMatrixAnalog","SigrootController","scaleInitialized","match","vendorId","productId","DeviceSelectionCancelled","requestDevice","knownDevices","device","systemDevices","hid","getDevices","manualDevices","devices","dev","reqestDeviceForWorker","getUnusedDevice","HIDOperations","send","report","data","bytes","arr","len","val","pad","feature","sendFeatureReport","id","sendReport","reply","receiveFeatureReport","byteLength","exp","act","Reports","Commands","BootMode","ReportAbstractionLayer","infoRaw","sleep_pin","getUint8","dip1_pin","intb_pin","state_flags","id_reg","config_reg","global_brightness","display_width","display_height","timeout_ms","getUint32","version_major","version_minor","disableSleep","disableDeepSleep","disableSleepTimer","enableDeepSleep","enableSleepTimer","milliseconds","view","DataView","ArrayBuffer","setInt32","reboot","mode","drawMatrix","drawPixel","drawLine","r1","c1","r2","c2","SparkleController","HardwareControllerFactory","detectSerial","detectHID"],"mappings":"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"}